<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>NinjaFlight: Battery Monitoring</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">NinjaFlight
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_docs_Battery.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Battery Monitoring </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Cleanflight has a battery monitoring feature. The voltage of the main battery can be measured by the system and used to trigger a low-battery warning <a class="el" href="Buzzer_8md.html">buzzer</a>, on-board status LED flashing and LED strip patterns.</p>
<p>Low battery warnings can:</p>
<ul>
<li>Help ensure you have time to safely land the aircraft</li>
<li>Help maintain the life and safety of your LiPo/LiFe batteries, which should not be discharged below manufacturer recommendations</li>
</ul>
<p>Minimum and maximum cell voltages can be set, and these voltages are used to auto-detect the number of cells in the battery when it is first connected.</p>
<p>Per-cell monitoring is not supported, as we only use one ADC to read the battery voltage.</p>
<h2>Supported targets</h2>
<p>All targets support battery voltage monitoring unless status.</p>
<h2>Connections</h2>
<p>When dealing with batteries <b>ALWAYS CHECK POLARITY!</b></p>
<p>Measure expected voltages <b>first</b> and then connect to the flight controller. Powering the flight controller with incorrect voltage or reversed polarity will likely fry your flight controller. Ensure your flight controller has a voltage divider capable of measuring your particular battery voltage.</p>
<h3>Naze32</h3>
<p>The Naze32 has an on-board battery divider circuit; just connect your main battery to the VBAT connector.</p>
<p><b>CAUTION:</b> When installing the connection from main battery to the VBAT connector, be sure to first disconnect the main battery from the frame/power distribution board. Check the wiring very carefully before connecting battery again. Incorrect connections can immediately and completely destroy the flight controller and connected peripherals (ESC, GPS, Receiver etc.).</p>
<h3>CC3D</h3>
<p>The CC3D has no battery divider. To use voltage monitoring, you must create a divider that gives a 3.3v MAXIMUM output when the main battery is fully charged. Connect the divider output to S5_IN/PA0/RC5.</p>
<p>Notes:</p>
<ul>
<li>S5_IN/PA0/RC5 is Pin 7 on the 8 pin connector, second to last pin, on the opposite end from the GND/+5/PPM signal input.</li>
<li>When battery monitoring is enabled on the CC3D, RC5 can no-longer be used for PWM input.</li>
</ul>
<h3>Sparky</h3>
<p>See the Board - Sparky.md "Sparky board chapter".</p>
<h2>Configuration</h2>
<p>Enable the <code>VBAT</code> feature.</p>
<p>Configure min/max cell voltages using the following CLI setting:</p>
<p><code>vbat_scale</code> - Adjust this to match actual measured battery voltage to reported value.</p>
<p><code>vbat_max_cell_voltage</code> - Maximum voltage per cell, used for auto-detecting battery voltage in 0.1V units, i.e. 43 = 4.3V</p>
<p><code>set vbat_warning_cell_voltage</code> - Warning voltage per cell; this triggers battery-out alarms, in 0.1V units, i.e. 34 = 3.4V</p>
<p><code>vbat_min_cell_voltage</code> - Minimum voltage per cell; this triggers battery-out alarms, in 0.1V units, i.e. 33 = 3.3V</p>
<p>e.g.</p>
<p>``` set vbat_scale = 110 set vbat_max_cell_voltage = 43 set vbat_warning_cell_voltage = 34 set vbat_min_cell_voltage = 33 ```</p>
<h1>Current Monitoring</h1>
<p>Current monitoring (amperage) is supported by connecting a current meter to the appropriate current meter ADC input (see the documentation for your particular board).</p>
<p>When enabled, the following values calculated and used by the telemetry and OLED display subsystems:</p><ul>
<li>Amps</li>
<li>mAh used</li>
<li>Capacity remaining</li>
</ul>
<h2>Configuration</h2>
<p>Enable current monitoring using the CLI command:</p>
<p>``` feature CURRENT_METER ```</p>
<p>Configure the current meter type using the <code>current_meter_type</code> settings here:</p>
<table class="doxtable">
<tr>
<th>Value </th><th>Sensor Type  </th></tr>
<tr>
<td>NONE </td><td>None </td></tr>
<tr>
<td>ADC </td><td>ADC/hardware sensor </td></tr>
<tr>
<td>VIRTUAL </td><td>Virtual sensor </td></tr>
</table>
<p>Configure capacity using the <code>battery_capacity</code> setting, in mAh units.</p>
<p>If you're using an OSD that expects the multiwii current meter output value, then set <code>multiwii_current_meter_output</code> to <code>ON</code> (this multiplies amperage sent to MSP by 10 and truncates negative values)).</p>
<h3>ADC Sensor</h3>
<p>The current meter may need to be configured so the value read at the ADC input matches actual current draw. Just like you need a voltmeter to correctly calibrate your voltage reading you also need an ammeter to calibrate the current sensor.</p>
<p>Use the following settings to adjust calibration:</p>
<p><code>current_meter_scale</code> <code>current_meter_offset</code></p>
<p>It is recommended to set <code>multiwii_current_meter_output</code> to <code>OFF</code> when calibrating ADC current sensor.</p>
<h3>Virtual Sensor</h3>
<p>The virtual sensor uses the throttle position to calculate an estimated current value. This is useful when a real sensor is not available. The following settings adjust the virtual sensor calibration:</p>
<table class="doxtable">
<tr>
<th>Setting </th><th>Description  </th></tr>
<tr>
<td><code>current_meter_scale</code> </td><td>The throttle scaling factor [centiamps, i.e. 1/100th A] </td></tr>
<tr>
<td><code>current_meter_offset</code> </td><td>The current at zero throttle (while disarmed) [centiamps, i.e. 1/100th A] </td></tr>
</table>
<p>There are two simple methods to tune these parameters: one uses a battery charger and another depends on actual current measurements.</p>
<h4>Tuning Using Actual Current Measurements</h4>
<p>If you know your craft's current draw (in Amperes) while disarmed (Imin) and at maximum throttle while armed (Imax), calculate the scaling factors as follows: ``` current_meter_scale = (Imax - Imin) * 100000 / (Tmax + (Tmax * Tmax / 50)) current_meter_offset = Imin * 100 ``<code> Note: Tmax is maximum throttle offset (i.e. for</code>max_throttle` = 1850, Tmax = 1850 - 1000 = 850)</p>
<p>For example, assuming a maximum current of 34.2A, a minimum current of 2.8A, and a Tmax <code>max_throttle</code> = 1850: ``` current_meter_scale = (Imax - Imin) * 100000 / (Tmax + (Tmax * Tmax / 50)) = (34.2 - 2.8) * 100000 / (850 + (850 * 850 / 50)) = 205 current_meter_offset = Imin * 100 = 280 ``` </p><h4>Tuning Using Battery Charger Measurement</h4>
<p>If you cannot measure current draw directly, you can approximate it indirectly using your battery charger. However, note it may be difficult to adjust <code>current_meter_offset</code> using this method unless you can measure the actual current draw with the craft disarmed.</p>
<p>Note:</p><ul>
<li>This method depends on the accuracy of your battery charger; results may vary.</li>
<li>If you add or replace equipment that changes the in-flight current draw (e.g. video transmitter, camera, gimbal, motors, prop pitch/sizes, ESCs, etc.), you should recalibrate.</li>
</ul>
<p>The general method is:</p>
<ol type="1">
<li>Fully charge your flight battery</li>
<li>Fly your craft, using &gt;50% of your battery pack capacity (estimated)</li>
<li>Note Cleanflight's reported mAh draw</li>
<li>Re-charge your flight battery, noting the mAh charging data needed to restore the pack to fully charged</li>
<li>Adjust <code>current_meter_scale</code> to according to the formula given below</li>
<li>Repeat and test</li>
</ol>
<p>Given (a) the reported mAh draw and the (b) mAh charging data, calculate a new <code>current_meter_scale</code> value as follows: ``` current_meter_scale = (charging_data_mAh / reported_draw_mAh) * old_current_meter_scale ``` For example, assuming:</p><ul>
<li>A Cleanflight reported current draw of 1260 mAh</li>
<li>Charging data to restore full charge of 1158 mAh</li>
<li>A existing <code>current_meter_scale</code> value of 400 (the default)</li>
</ul>
<p>Then the updated <code>current_meter_scale</code> is: ``` current_meter_scale = (charging_data_mAh / reported_draw_mAh) * old_current_meter_scale = (1158 / 1260) * 400 = 368 ``` </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Dec 12 2016 15:48:58 for NinjaFlight by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.7 </li>
  </ul>
</div>
</body>
</html>
