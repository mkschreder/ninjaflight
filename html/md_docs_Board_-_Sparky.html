<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.7"/>
<title>NinjaFlight: Board - Sparky</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">NinjaFlight
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.7 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_docs_Board_-_Sparky.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Board - Sparky </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Sparky is a very low cost and very powerful board.</p>
<ul>
<li>3 hardware serial ports.</li>
<li>Built-in serial port inverters which allows S.BUS receivers to be used without external inverters.</li>
<li>USB (can be used at the same time as the serial ports).</li>
<li>10 PWM outputs.</li>
<li>Dedicated PPM/SerialRX input pin.</li>
<li>MPU9150 I2C Acc/Gyro/Mag</li>
<li>Baro</li>
</ul>
<p>Tested with revision 1 &amp; 2 boards.</p>
<h2>TODO</h2>
<ul>
<li>Display (via Flex port)</li>
<li>SoftSerial - though having 3 hardware serial ports makes it a little redundant.</li>
<li>Airplane PWM mappings.</li>
</ul>
<h1>Voltage and current monitoring (ADC support)</h1>
<p>Voltage monitoring is possible when enabled via PWM9 pin and current can be monitored via PWM8 pin. The voltage divider and current sensor need to be connected externally. The vbatscale cli parameter need to be adjusted to fit the sensor specification. For more details regarding the sensor hardware you can check here: <a href="https://github.com/TauLabs/TauLabs/wiki/User-Guide:-Battery-Configuration">https://github.com/TauLabs/TauLabs/wiki/User-Guide:-Battery-Configuration</a></p>
<h1>Flashing</h1>
<h2>Via Device Firmware Upload (DFU, USB) - Windows</h2>
<p>These instructions are for flashing the Sparky board under Windows using DfuSE. Credits go to Thomas Shue (Full video of the below steps can be found here: <a href="https://www.youtube.com/watch?v=I4yHiRVRY94">https://www.youtube.com/watch?v=I4yHiRVRY94</a>)</p>
<p>Required Software: DfuSE Version 3.0.2 (latest version 3.0.4 causes errors): <a href="http://code.google.com/p/multipilot32/downloads/detail?name=DfuSe.rar">http://code.google.com/p/multipilot32/downloads/detail?name=DfuSe.rar</a> STM VCP Driver 1.4.0: <a href="http://www.st.com/web/en/catalog/tools/PF257938">http://www.st.com/web/en/catalog/tools/PF257938</a></p>
<p>A binary file is required for DFU, not a .hex file. If one is not included in the release then build one as follows.</p>
<p>``` Unpack DfuSE and the STM VCP Drivers into a folder on your Hardrive Download the latest Sparky release (cleanflight_SPARKY.hex) from: <a href="https://github.com/cleanflight/cleanflight/releases">https://github.com/cleanflight/cleanflight/releases</a> and store it on your Hardrive</p>
<p>In your DfuSE folder go to BIN and start DfuFileMgr.exe Select: "I want to GENERATE a DFUfile from S19,HEX or BIN files" press OK Press: "S19 or Hex.." Go to the folder where you saved the cleanflight_SPARKY.hex file, select it and press open (you might need to change the filetype in the DfuSE explorer window to "hex Files (*.hex)" to be able to see the file) Press: "Generate" and select the .dfu output file and location If all worked well you should see " Success for 'Image for lternate Setting 00 (ST..)'!"</p>
<p>```</p>
<p>Put the device into DFU mode by powering on the sparky with the bootloader pins temporarily bridged. The only light that should come on is the blue PWR led.</p>
<p>Check the windows device manager to make sure the board is recognized correctly. It should show up as "STM Device in DFU mode" under Universal Serial Bus Controllers</p>
<p>If it shows up as "STMicroelectronics Virtual COM" under Ports (COM &amp; LPT) instead then the board is not in DFU mode. Disconnect the board, short the bootloader pins again while connecting the board.</p>
<p>If the board shows up as "STM 32 Bootloader" device in the device manager, the drivers need to be updated manually. Select the device in the device manager, press "update drivers", select "manual update drivers" and choose the location where you extracted the STM VCP Drivers, select "let me choose which driver to install". You shoud now be able to select either the STM32 Bootloader driver or the STM in DFU mode driver. Select the later and install.</p>
<p>Then flash the binary as below.</p>
<p>``` In your DfuSE folder go to BIN and start DfuSeDemo.exe Select the Sparky Board (STM in DFU Mode) from the Available DFU and compatible HID Devices drop down list Press "Choose.." at the bootom of the window and select the .dfu file created in the previous step "File correctly loaded" should appear in the status bar Press "Upgrade" and confirm with "Yes" The status bar will show the upload progress and confirm that the upload is complete at the end</p>
<p>```</p>
<p>Disconnect and reconnect the board from USB and continue to configure it via the Cleanflight configurator as per normal</p>
<h2>Via Device Firmware Upload (DFU, USB) - Mac OS X / Linux</h2>
<p>These instructions are for dfu-util, tested using dfu-util 0.7 for OSX from the OpenTX project.</p>
<p><a href="http://www.open-tx.org/2013/07/15/dfu-util-07-for-mac-taranis-flashing-utility/">http://www.open-tx.org/2013/07/15/dfu-util-07-for-mac-taranis-flashing-utility/</a></p>
<p>A binary file is required for DFU, not a .hex file. If one is not included in the release then build one as follows.</p>
<p>``` make TARGET=SPARKY clean make TARGET=SPARKY binary ```</p>
<p>Put the device into DFU mode by powering on the sparky with the bootloader pins temporarily bridged. The only light that should come on is the blue PWR led.</p>
<p>Run 'dfu-util -l' to make sure the device is listed, as below.</p>
<p>``` $ dfu-util -l dfu-util 0.7</p>
<p>Copyright 2005-2008 Weston Schmidt, Harald Welte and OpenMoko Inc. Copyright 2010-2012 Tormod Volden and Stefan Schmidt This program is Free Software and has ABSOLUTELY NO WARRANTY Please report bugs to <a href="#" onclick="location.href='mai'+'lto:'+'dfu'+'-u'+'til'+'@l'+'ist'+'s.'+'gnu'+'mo'+'nks'+'.o'+'rg'; return false;">dfu-u<span style="display: none;">.nosp@m.</span>til@<span style="display: none;">.nosp@m.</span>lists<span style="display: none;">.nosp@m.</span>.gnu<span style="display: none;">.nosp@m.</span>monks<span style="display: none;">.nosp@m.</span>.org</a></p>
<p>Found DFU: [0483:df11] devnum=0, cfg=1, intf=0, alt=0, name="@Internal Flash  /0x08000000/128*0002Kg" Found DFU: [0483:df11] devnum=0, cfg=1, intf=0, alt=1, name="@Option Bytes  /0x1FFFF800/01*016 e" ```</p>
<p>Then flash the binary as below.</p>
<p>``` dfu-util -D obj/cleanflight_SPARKY.bin &ndash;alt 0 -R -s 0x08000000 ```</p>
<p>The output should be similar to this:</p>
<p>``` dfu-util 0.7</p>
<p>Copyright 2005-2008 Weston Schmidt, Harald Welte and OpenMoko Inc. Copyright 2010-2012 Tormod Volden and Stefan Schmidt This program is Free Software and has ABSOLUTELY NO WARRANTY Please report bugs to <a href="#" onclick="location.href='mai'+'lto:'+'dfu'+'-u'+'til'+'@l'+'ist'+'s.'+'gnu'+'mo'+'nks'+'.o'+'rg'; return false;">dfu-u<span style="display: none;">.nosp@m.</span>til@<span style="display: none;">.nosp@m.</span>lists<span style="display: none;">.nosp@m.</span>.gnu<span style="display: none;">.nosp@m.</span>monks<span style="display: none;">.nosp@m.</span>.org</a></p>
<p>Opening DFU capable USB device... ID 0483:df11 Run-time device DFU version 011a Found DFU: [0483:df11] devnum=0, cfg=1, intf=0, alt=0, name="@Internal Flash  /0x08000000/128*0002Kg" Claiming USB DFU Interface... Setting Alternate Setting #0 ... Determining device status: state = dfuERROR, status = 10 dfuERROR, clearing status Determining device status: state = dfuIDLE, status = 0 dfuIDLE, continuing DFU mode device DFU version 011a Device returned transfer size 2048 No valid DFU suffix signature Warning: File has no DFU suffix DfuSe interface name: "Internal Flash  " Downloading to address = 0x08000000, size = 76764 ...................................... File downloaded successfully can't detach Resetting USB to switch back to runtime mode</p>
<p>``` On Linux you might want to take care that the modemmanager isn't trying to use your sparky as modem getting it into bootloader mode while doing so. In doubt you probably want to uninstall it. It could also be good idea to get udev fixed. It looks like teensy did just that -&gt; <a href="http://www.pjrc.com/teensy/49-teensy.rules">http://www.pjrc.com/teensy/49-teensy.rules</a> (untested)</p>
<p>To make a full chip erase you can use a file created by ``` dd if=/dev/zero of=zero.bin bs=1 count=262144 ``` This can be used by dfu-util.</p>
<h2>Via SWD</h2>
<p>On the bottom of the board there is an SWD header socket onto switch a JST-SH connector can be soldered. Once you have SWD connected you can use the st-link or j-link tools to flash a binary.</p>
<p>See Sparky schematic for CONN2 pinouts.</p>
<h2>TauLabs bootloader</h2>
<p>Flashing cleanflight will erase the TauLabs bootloader, this is not a problem and can easily be restored using the st flashloader tool.</p>
<h1>Serial Ports</h1>
<table class="doxtable">
<tr>
<th>Value </th><th>Identifier </th><th>RX </th><th>TX </th><th>Notes  </th></tr>
<tr>
<td>1 </td><td>USB VCP </td><td>RX (USB) </td><td>TX (USB) </td><td></td></tr>
<tr>
<td>2 </td><td>USART1 </td><td>RX / PB7 </td><td>TX / PB6 </td><td>Conn1 / Flexi Port. </td></tr>
<tr>
<td>3 </td><td>USART2 </td><td>RX / PA3 </td><td>PWM6 / PA2 </td><td>On RX is on INPUT header. Best port for Serial RX input </td></tr>
<tr>
<td>4 </td><td>USART3 </td><td>RX / PB11 </td><td>TX / PB10 </td><td>RX/TX is on one end of the 6-pin header above the PWM outputs. </td></tr>
</table>
<p>USB VCP <em>can</em> be used at the same time as other serial ports (unlike Naze32).</p>
<p>All USART ports all support automatic hardware inversion which allows direct connection of serial rx receivers like the FrSky X4RSB - no external inverter needed.</p>
<h1>Sonar Connections</h1>
<table class="doxtable">
<tr>
<th>Pin </th><th>Signal </th><th>Function </th><th>Resistor  </th></tr>
<tr>
<td>PWM6 </td><td>PA2 </td><td>Trigger pin </td><td>1K Ohm </td></tr>
<tr>
<td>PWM7 </td><td>PB1 </td><td>Echo pin </td><td>1K Ohm </td></tr>
</table>
<p>WARNING: Both PWM6 and PWM7 pins are NOT 5 volt tolerant, so a 1K Ohm resistor is required between the sensor and the FC pins.</p>
<h1>Battery Monitoring Connections</h1>
<table class="doxtable">
<tr>
<th>Pin </th><th>Signal </th><th>Function  </th></tr>
<tr>
<td>PWM9 </td><td>PA4 </td><td>Battery Voltage </td></tr>
<tr>
<td>PWM8 </td><td>PA7 </td><td>Current Meter </td></tr>
</table>
<h2>Voltage Monitoring</h2>
<p>The Sparky has no battery divider cricuit, PWM9 has an inline 10k resistor which has to be factored into the resistor calculations. The divider circuit should eventally create a voltage between 0v and 3.3v (MAX) at the MCU input pin.</p>
<p>WARNING: Double check the output of your voltage divider using a voltmeter <em>before</em> connecting to the FC.</p>
<h3>Example Circuit</h3>
<p>For a 3Cell battery divider the following circuit works:</p>
<p><code>Battery (+) ---&lt; R1 &gt;--- PWM9 ---&lt; R2 &gt;--- Battery (-)</code></p>
<ul>
<li>R1 = 8k2 (Grey Red Red)</li>
<li>R2 = 2k0 (Red Black Red)</li>
</ul>
<p>This gives a 2.2k for an 11.2v battery. The <code>vbat_scale</code> for this divider should be set around <code>52</code>.</p>
<h2>Current Monitoring</h2>
<p>Connect a current sensor to PWM8/PA7 that gives a range between 0v and 3.3v out (MAX). </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Dec 12 2016 15:48:58 for NinjaFlight by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.7 </li>
  </ul>
</div>
</body>
</html>
